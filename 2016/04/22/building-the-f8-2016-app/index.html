<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 构建2016 F8 app · 深谷</title><meta name="description" content="本文主要翻译了Facebook F8 app的构建过程系列文章。原文链接：makeitopen.com"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/yiyangest" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">构建2016 F8 app</h1><div class="post-time">2016年4月22日</div><div class="post-content"><h2 id="App准备阶段"><a href="#App准备阶段" class="headerlink" title="App准备阶段"></a>App准备阶段</h2><p><em>这是在开发F8 2016大会iOS和Android客户端过程中写下的一系列用来介绍React Native和它的开源生态圈的教程.</em></p>
<p>在第一部分，我们将讲述是如何计划准备这款app的；后续部分我们将分享一些示例代码，讨论如何考虑多平台设计，分析我们app当中的数据层，并且解释我们的测试策略。</p>
<a id="more"></a>
<h3 id="切换到React-Native"><a href="#切换到React-Native" class="headerlink" title="切换到React Native"></a>切换到React Native</h3><p>在2015年，F8开发者大会的iOS客户端是用React Native来开发的，但是Android版本仍然是用原生代码开发的；在前几年，两个平台都是使用各自iOS和Android的原生代码开发的。从2015开发者大会以后，React Native也发布了Android版本，而这也代表了一个可以分离app的逻辑和UI代码的契机。一些Facebook团队已经发现当使用React Native时有<a href="https://code.facebook.com/posts/1189117404435352/react-native-for-android-how-we-built-the-first-cross-platform-react-native-app/" target="_blank" rel="noopener">大约85%的app代码可以复用</a>。</p>
<p>React Native还具有可以在同UI设计师紧密合作过程中快速将可视化组件制作成原型的好处 －－ 我们将会在第二部分讨论。</p>
<p>因此，如果我们要切换到React Native，还有什么别的需要我们去考虑的？让我们从内容开始。</p>
<h3 id="选择数据层"><a href="#选择数据层" class="headerlink" title="选择数据层"></a>选择数据层</h3><p>2014和2015的F8 app都使用<a href="https://parse.com" target="_blank" rel="noopener">Parse云服务</a>来作为数据后端。因此当开始计划2016的F8 app时，Parse有重用现有的数据架构快速开始的优势。</p>
<p>使用Parse也有一些其它的原因 － app里要展示的大多数内容需要很频繁的更新，包括在会议期间，并且它要能无需任何技术专家（例如要求至少熟悉编辑excel表格）就能够更新。Parse云服务后台管理系统是满足这些需求的完美工具。</p>
<p>综上所述，Parse是F8 app数据后端的最佳选择。依据<a href="http://blog.parse.com/announcements/moving-on/" target="_blank" rel="noopener">Parse云服务关闭公告</a>，我们决定转移使用新开源的<a href="http://blog.parse.com/announcements/introducing-parse-server-and-the-database-migration-tool/" target="_blank" rel="noopener">Parse服务端</a>和<a href="https://github.com/ParsePlatform/parse-dashboard" target="_blank" rel="noopener">Parse后台管理系统</a>。</p>
<p>由于React Native并不需要和数据层紧密相联，例如React Native的UI和逻辑部分的开发可以通过简单的模拟数据来完成。这意味着只要数据层的结构保持不变，你可以花费最小的调整来切换一个开发好的app的数据源。对于F8 App来说，这意味着在app已经开发完后，我们仍可以非常轻松的将Parse云服务迁移到开源的Parse服务端。我们会在数据教程部分介绍更多这方面的内容。</p>
<h3 id="React-Native的数据访问"><a href="#React-Native的数据访问" class="headerlink" title="React Native的数据访问"></a>React Native的数据访问</h3><p>为了整合Parse和React Native，虽然已经有一个现成的<a href="https://github.com/ParsePlatform/ParseReact" target="_blank" rel="noopener">Parse+React包</a>，提供了必要的绑定工具，但仍有一个问题 － 由于会议无线网络连接的不稳定性，F8 app必须能够在离线的情况下使用。因为在F8 app开发阶段，Parse+React还并不支持离线同步数据，所以我们必须构建我们自己的离线支持。</p>
<p>在做这些决定的时候还有另一个影响因素 － 团队大小。例如Relay更适合于一个有一定规模的大团队，但是F8 app只有一个人开发，加上另一些设计支持。这对你开发app时使用哪种类型的数据读取方式有很大影响。</p>
<p>那<a href="http://graphql.org/" target="_blank" rel="noopener">GraphQL</a>和<a href="https://facebook.github.io/relay/" target="_blank" rel="noopener">Relay</a>怎么样？尽管它们非常适合React Native，但<a href="https://github.com/facebook/relay/wiki/Roadmap#in-progress" target="_blank" rel="noopener">那时候</a>Relay还不支持离线使用，而GraphQL不支持在Parse之外使用。使用这些方法开发app要求开发一套GraphQL-Parse的API和Relay的离线存储方法。</p>
<p>GrapQL服务端的搭建对一个人短时间内来说有一些复杂。记住当我们要在app store发布这款app，我们想要的是最简单最快速的方法，那还有哪些其它的选择呢？</p>
<p>考虑以上，<a href="https://github.com/rackt/redux" target="_blank" rel="noopener">Redux</a>是最佳选择。Redux提供了一个<a href="https://facebook.github.io/flux/" target="_blank" rel="noopener">Flux架构</a>的简单实现，在数据该如何存储和缓存方面提供更多的控制，本质上使app能够同Parse云服务进行单向同步。</p>
<p>在app商店的版本中，Redux保证了app里功能性和易用性方面的平衡。当app发布以后，我们重新考虑了这个，并且在app当中部分使用了Relay和GraphQL，我们将在附录：Relay和GrapQL中介绍这次迁移。</p>
<h3 id="我们的开发栈"><a href="#我们的开发栈" class="headerlink" title="我们的开发栈"></a>我们的开发栈</h3><p>有React Native作为我们选择的app框架，Redux作为数据层，我们还需要选择一些支持的技术和工具：</p>
<ul>
<li>开源的<a href="https://github.com/ParsePlatform/parse-server" target="_blank" rel="noopener">Parse服务端</a>，提供数据存储 － 运行在<a href="https://nodejs.org/en" target="_blank" rel="noopener">Node.js</a>之上。</li>
<li>启用<a href="http://flowtype.org/" target="_blank" rel="noopener">Flow</a>来捕获我们React Native中Javascript代码的类型错误。</li>
<li>使用<a href="http://facebook.github.io/jest/" target="_blank" rel="noopener">Jest框架</a>为一些复杂的方法编写单元测试。</li>
<li>使用<a href="https://github.com/facebook/react-native-fbsdk" target="_blank" rel="noopener">React Native Facebook SDK</a>来快速集成在iOS和Android上访问Facebook数据。</li>
<li>我们在OXS上使用Facebook开发的<a href="http://nuclide.io/docs/platforms/react-native/" target="_blank" rel="noopener">内置支持React Native</a>的<a href="http://nuclide.io" target="_blank" rel="noopener">Nuclide</a>编辑器。</li>
<li>我们使用git作为版本控制工具，并在<a href="https://github.com/fbsamples/f8app" target="_blank" rel="noopener">GitHub</a>上记录进度。</li>
</ul>
<p>我们还使用了一些其它的小工具包，我们将会在各篇教程中介绍。</p>
<p><em>在你进行到下一章节之前，我们建议你学习一些<a href="http://facebook.github.io/react/docs/tutorial.html" target="_blank" rel="noopener">React.js的基本知识</a> － 尤其是它的<a href="http://facebook.github.io/react/docs/thinking-in-react.html#step-1-break-the-ui-into-a-component-hierarchy" target="_blank" rel="noopener">模块化组件概念</a>和<a href="http://facebook.github.io/react/docs/jsx-in-depth.html" target="_blank" rel="noopener">JSX语法</a>。然后跟着<a href="http://facebook.github.io/react-native/docs/tutorial.html#content" target="_blank" rel="noopener">React Native的介绍教程</a>学习如何将这些应用到移动app当中。</em></p>
<h2 id="为多平台设计App"><a href="#为多平台设计App" class="headerlink" title="为多平台设计App"></a>为多平台设计App</h2><p>React Native的众多亮点之一是它很简单就能创建可同时运行在iOS和Android之上的app，不必要用不同的原生语言去重复编写大部分的app逻辑。</p>
<p>然而，React Native的哲学理念一直是”learn once, write anywhere”, 而不是”write once, run anywhere”。这个微妙的区别意味着用React Native开发的app应该为每个平台量身定制，而不是完全一模一样。</p>
<p>从UI层面来看，由于平台在可视化样式、UI范例，甚至是技术能力上都有或多或少的区别，那从一个公共的UI基础样式开始，然后对每个平台做微调就显得很有必要。</p>
<h4 id="在我们开始之前"><a href="#在我们开始之前" class="headerlink" title="在我们开始之前"></a>在我们开始之前</h4><p>在这个和接下来的教程里，我们将会深入到app本身的代码中，因此你应该将<a href="https://github.com/fbsamples/f8app" target="_blank" rel="noopener">源代码</a>克隆到任何一个你方便查看的地方。你还可以根据<a href="http://makeitopen.com/tutorials/building-the-f8-app/local-setup/" target="_blank" rel="noopener">我们的安装指南</a>在你本地运行此app，但是如果仅为了此篇教程，你只需要可以查看浏览源代码即可。</p>
<h3 id="React-Native思维模式"><a href="#React-Native思维模式" class="headerlink" title="React Native思维模式"></a>React Native思维模式</h3><p>在我们写任何React代码之前，有一个很重要的概念会指明你如何思考一个React app的每一处细节。这个概念就是<strong>你的代码应尽可能的重用</strong>.</p>
<p>这似乎和为每一个平台量身定制视觉效果的想法有些矛盾 － 这个量身定制的想法可能会创建独立分开的iOS和Android可视化组件 － 但这也要求React Native开发的app仍要尽可能多的共享重叠的部分。</p>
<p>当考虑开发React Native app中的可视化组件时，成功的关键是使用平台抽象。开发者和设计师制定一系列app中的可复用组件 － 例如”button”, “container”, “list row”, “header”等等 － 只有当需要的时候，才从这些公共的版本中演化出其它组件。</p>
<p>当然，一些组件会比其它组件复杂的多，那就让我们来探索一下F8 app当中的一些不同的组件。</p>
<h3 id="差异化小组件"><a href="#差异化小组件" class="headerlink" title="差异化小组件"></a>差异化小组件</h3><p>这是F8 app当中的一个例子：</p>
<p><img src="https://raw.githubusercontent.com/facebook/makeitopen/gh-pages/static/images/iOS%20vs%20Android%20Segmented%20Controls%403x.png" alt="iOS和Android的Segmented Controls的对比"></p>
<p>在iOS当中，tab控件使用iOS用户很熟悉的圆角按钮样式，而Android版本的这个控件使用更贴合平台的下划线样式。不管怎样，两个控件具有完全相同的功能。</p>
<p>因此，尽管视觉上它们有细微的不同，但是还是很值得重复强调它们应当<strong>尽可能的重用代码</strong>。</p>
<p>对于一个类似这样的小组件，跨平台的时候在牵涉到的逻辑上我们有很大一部分是重叠的 － 它展示文本按钮，具有’hover’和’active’的样式，唯一区别是细微的样式差异 － 因此最好的方式是用一个单一的组件，然后在必要的时候使用控制语句来实现此组件。</p>
<p>接下来以上面这个组件作为一个例子（来自于<code>&lt;F8SegmentedControl&gt;</code>):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/common/F8SegmentedControl.js */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Segment</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    value: string;</span><br><span class="line">    isSelected: boolean;</span><br><span class="line">    selectionColor: string;</span><br><span class="line">    onPress: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">render() &#123;</span><br><span class="line">    <span class="keyword">var</span> selectedButtonStyle;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.isSelected) &#123;</span><br><span class="line">      selectedButtonStyle = &#123; <span class="attr">borderColor</span>: <span class="keyword">this</span>.props.selectionColor &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> deselectedLabelStyle;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.props.isSelected &amp;&amp; Platform.OS === <span class="string">'android'</span>) &#123;</span><br><span class="line">      deselectedLabelStyle = styles.deselectedLabel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> title = <span class="keyword">this</span>.props.value &amp;&amp; <span class="keyword">this</span>.props.value.toUpperCase();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> accessibilityTraits = [<span class="string">'button'</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.isSelected) &#123;</span><br><span class="line">      accessibilityTraits.push(<span class="string">'selected'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;TouchableOpacity</span><br><span class="line">        accessibilityTraits=&#123;accessibilityTraits&#125;</span><br><span class="line">        activeOpacity=&#123;<span class="number">0.8</span>&#125;</span><br><span class="line">        onPress=&#123;<span class="keyword">this</span>.props.onPress&#125;</span><br><span class="line">        style=&#123;[styles.button, selectedButtonStyle]&#125;&gt;</span><br><span class="line">        &lt;Text style=&#123;[styles.label, deselectedLabelStyle]&#125;&gt;</span><br><span class="line">          &#123;title&#125;</span><br><span class="line">        &lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>TouchableOpacity&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们简单的根据代码所运行的平台(使用React Native的<a href="https://facebook.github.io/react-native/docs/platform-specific-code.html#platform-module" target="_blank" rel="noopener">Platform模块</a>)来设置不同的样式。两个平台的tab按钮都接受一些共同的样式，但是又有所不同（仍然来自<code>&lt;F8SegmentedControl&gt;</code>):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/common/F8SegmentedControl.js */</span></span><br><span class="line"><span class="keyword">var</span> styles = F8StyleSheet.create(&#123;</span><br><span class="line">  container: &#123;</span><br><span class="line">    flexDirection: <span class="string">'row'</span>,</span><br><span class="line">    backgroundColor: <span class="string">'transparent'</span>,</span><br><span class="line">    ios: &#123;</span><br><span class="line">      paddingBottom: <span class="number">6</span>,</span><br><span class="line">      justifyContent: <span class="string">'center'</span>,</span><br><span class="line">      alignItems: <span class="string">'center'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    android: &#123;</span><br><span class="line">      paddingLeft: <span class="number">60</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  button: &#123;</span><br><span class="line">    borderColor: <span class="string">'transparent'</span>,</span><br><span class="line">    alignItems: <span class="string">'center'</span>,</span><br><span class="line">    justifyContent: <span class="string">'center'</span>,</span><br><span class="line">    backgroundColor: <span class="string">'transparent'</span>,</span><br><span class="line">    ios: &#123;</span><br><span class="line">      height: HEIGHT,</span><br><span class="line">      paddingHorizontal: <span class="number">20</span>,</span><br><span class="line">      borderRadius: HEIGHT / <span class="number">2</span>,</span><br><span class="line">      borderWidth: <span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    android: &#123;</span><br><span class="line">      paddingBottom: <span class="number">6</span>,</span><br><span class="line">      paddingHorizontal: <span class="number">10</span>,</span><br><span class="line">      borderBottomWidth: <span class="number">3</span>,</span><br><span class="line">      marginRight: <span class="number">10</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  label: &#123;</span><br><span class="line">    letterSpacing: <span class="number">1</span>,</span><br><span class="line">    fontSize: <span class="number">12</span>,</span><br><span class="line">    color: <span class="string">'white'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  deselectedLabel: &#123;</span><br><span class="line">    color: <span class="string">'rgba(255, 255, 255, 0.7)'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里我们使用了一个经过修改的<a href="https://facebook.github.io/react-native/docs/stylesheet.html" target="_blank" rel="noopener">React Native StyleSheet API</a>，包含了一些额外的可以根据平台自动切换样式的功能：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">styles: Object</span>): </span>&#123;[name: string]: number&#125; &#123;</span><br><span class="line">  <span class="keyword">const</span> platformStyles = &#123;&#125;;</span><br><span class="line">  <span class="built_in">Object</span>.keys(styles).forEach(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;ios, android, ...style&#125; = &#123;...styles[name]&#125;;</span><br><span class="line">    <span class="keyword">if</span> (ios &amp;&amp; Platform.OS === <span class="string">'ios'</span>) &#123;</span><br><span class="line">      style = &#123;...style, ...ios&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (android &amp;&amp; Platform.OS === <span class="string">'android'</span>) &#123;</span><br><span class="line">      style = &#123;...style, ...android&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    platformStyles[name] = style;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> StyleSheet.create(platformStyles);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个<code>F8StyleSheet</code>方法中，我们解析所提供的对象(之前代码示例中的<code>styles</code>对象)，如果我们发现有一个key叫做<code>ios</code>或者<code>android</code>，并且符合app正运行的平台，那我们会使用这个key对应的样式，如果不符合正运行的平台，那这部分代码将被忽略。这给我们提供了另一个简单的例子来说明React的尽可能重用共同的样式代码来减少代码重复的思路。</p>
<p>现在我们可以在app当中重用这个组件，并且它会根据iOS或者Android使用适当的样式。</p>
<h3 id="分离复杂的差别"><a href="#分离复杂的差别" class="headerlink" title="分离复杂的差别"></a>分离复杂的差别</h3><p>当一个组件在两个平台上的实现在逻辑上没有多少可共享的，并且不光在外观上有所不同，我们需要另一种实现方式。下面这个例子是app中最顶层的菜单导航：</p>
<p><img src="https://raw.githubusercontent.com/facebook/makeitopen/gh-pages/static/images/iOS vs. Android@3x.png" alt="iOS和Android主导航比较"></p>
<p>正如你所看见的，iOS版本的导航是在屏幕下方固定的tab，而Android版本则实现了一个带侧滑导航的汉堡式菜单。这在额外的动画，样式甚至是菜单项本身都有着显著的区别。Android客户端可能会包含更多的导航菜单选项，例如一个登出的选项。</p>
<p>你<em>可以</em>继续用一个单一的组件来实现所有这些，但是这个组件的逻辑将会充满大量的控制语句，并且这很快就会使代码变的难以理解。</p>
<p>取而代之的是，我们可以利用React Native内置的<a href="http://facebook.github.io/react-native/docs/platform-specific-code.html#platform-specific-extensions" target="_blank" rel="noopener">指定平台扩展名</a>的优势。我们将创建两个不同的组件，在这个例子当中一个叫做<code>F8TabsView.ios.js</code>，另一个叫做<code>F8TabsView.android.js</code> - React Native会自动检测并且根据不同的扩展名为各个平台加载正确的组件。</p>
<h4 id="内建的UI组件"><a href="#内建的UI组件" class="headerlink" title="内建的UI组件"></a>内建的UI组件</h4><p>在每个<code>FBTabsView</code>组件内部，我们仍然可以使用一些内建的React Native UI元素。Android版本使用了<code>DrawerLayoutAndroid</code>(你可以根据组件的名字来推断出这只在Android app当中有效)：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/tabs/F8TabsView.android.js */</span></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;DrawerLayoutAndroid</span><br><span class="line">      ref=<span class="string">"drawer"</span></span><br><span class="line">      drawerWidth=&#123;<span class="number">300</span>&#125;</span><br><span class="line">      drawerPosition=&#123;DrawerLayoutAndroid.positions.Left&#125;</span><br><span class="line">      renderNavigationView=&#123;<span class="keyword">this</span>.renderNavigationView&#125;&gt;</span><br><span class="line">      &lt;View style=&#123;styles.content&#125; key=&#123;<span class="keyword">this</span>.props.activeTab&#125;&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.renderContent()&#125;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>DrawerLayoutAndroid&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在第8行，我们指引这个drawer组件去寻找这个类当中的<code>renderNavigationView()</code>方法。这个方法会返回打开的抽屉(drawer)中要显示的内容。在这个例子当中，我们将会显示一个<a href="http://facebook.github.io/react-native/docs/scrollview.html" target="_blank" rel="noopener"><code>ScrollView</code></a>组件，ScrollView内部由自定义的<code>MenuItem</code>组件(参考<a href="https://github.com/fbsamples/f8app/blob/master/js/tabs/MenuItem.js" target="_blank" rel="noopener"><code>MenuItem.js</code></a>)填充：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/tabs/F8TabsView.android.js */</span></span><br><span class="line">renderNavigationView() &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span>(</span><br><span class="line">    &lt;ScrollView style=&#123;styles.drawer&#125;&gt;</span><br><span class="line">      &lt;MenuItem</span><br><span class="line">        title=<span class="string">"Schedule"</span></span><br><span class="line">        selected=&#123;<span class="keyword">this</span>.props.activeTab === <span class="string">'schedule'</span>&#125;</span><br><span class="line">        onPress=&#123;<span class="keyword">this</span>.onTabSelect.bind(<span class="keyword">this</span>, <span class="string">'schedule'</span>)&#125;</span><br><span class="line">        icon=&#123;scheduleIcon&#125;</span><br><span class="line">        selectedIcon=&#123;scheduleIconSelected&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;MenuItem</span><br><span class="line">        title=<span class="string">"My F8"</span></span><br><span class="line">        selected=&#123;<span class="keyword">this</span>.props.activeTab === <span class="string">'my-schedule'</span>&#125;</span><br><span class="line">        onPress=&#123;<span class="keyword">this</span>.onTabSelect.bind(<span class="keyword">this</span>, <span class="string">'my-schedule'</span>)&#125;</span><br><span class="line">        icon=&#123;<span class="built_in">require</span>(<span class="string">'./schedule/img/my-schedule-icon.png'</span>)&#125;</span><br><span class="line">        selectedIcon=&#123;<span class="built_in">require</span>(<span class="string">'./schedule/img/my-schedule-icon-active.png'</span>)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;MenuItem</span><br><span class="line">        title=<span class="string">"Map"</span></span><br><span class="line">        selected=&#123;<span class="keyword">this</span>.props.activeTab === <span class="string">'map'</span>&#125;</span><br><span class="line">        onPress=&#123;<span class="keyword">this</span>.onTabSelect.bind(<span class="keyword">this</span>, <span class="string">'map'</span>)&#125;</span><br><span class="line">        icon=&#123;<span class="built_in">require</span>(<span class="string">'./maps/img/maps-icon.png'</span>)&#125;</span><br><span class="line">        selectedIcon=&#123;<span class="built_in">require</span>(<span class="string">'./maps/img/maps-icon-active.png'</span>)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;MenuItem</span><br><span class="line">        title=<span class="string">"Notifications"</span></span><br><span class="line">        selected=&#123;<span class="keyword">this</span>.props.activeTab === <span class="string">'notifications'</span>&#125;</span><br><span class="line">        onPress=&#123;<span class="keyword">this</span>.onTabSelect.bind(<span class="keyword">this</span>, <span class="string">'notifications'</span>)&#125;</span><br><span class="line">        badge=&#123;<span class="keyword">this</span>.state.notificationsBadge&#125;</span><br><span class="line">        icon=&#123;<span class="built_in">require</span>(<span class="string">'./notifications/img/notifications-icon.png'</span>)&#125;</span><br><span class="line">        selectedIcon=&#123;<span class="built_in">require</span>(<span class="string">'./notifications/img/notifications-icon-active.png'</span>)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;MenuItem</span><br><span class="line">        title=<span class="string">"Info"</span></span><br><span class="line">        selected=&#123;<span class="keyword">this</span>.props.activeTab === <span class="string">'info'</span>&#125;</span><br><span class="line">        onPress=&#123;<span class="keyword">this</span>.onTabSelect.bind(<span class="keyword">this</span>, <span class="string">'info'</span>)&#125;</span><br><span class="line">        icon=&#123;<span class="built_in">require</span>(<span class="string">'./info/img/info-icon.png'</span>)&#125;</span><br><span class="line">        selectedIcon=&#123;<span class="built_in">require</span>(<span class="string">'./info/img/info-icon-active.png'</span>)&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;<span class="regexp">/ScrollView&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>相较而言，iOS版本直接在<code>render()</code>方法中使用了一个不同的内建组件，<a href="http://facebook.github.io/react-native/docs/tabbarios.html" target="_blank" rel="noopener"><code>TabBarIOS</code></a>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/tabs/F8TabsView.ios.js */</span></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">var</span> scheduleIcon = <span class="keyword">this</span>.props.day === <span class="number">1</span></span><br><span class="line">    ? <span class="built_in">require</span>(<span class="string">'./schedule/img/schedule-icon-1.png'</span>)</span><br><span class="line">    : <span class="built_in">require</span>(<span class="string">'./schedule/img/schedule-icon-2.png'</span>);</span><br><span class="line">  <span class="keyword">var</span> scheduleIconSelected = <span class="keyword">this</span>.props.day === <span class="number">1</span></span><br><span class="line">    ? <span class="built_in">require</span>(<span class="string">'./schedule/img/schedule-icon-1-active.png'</span>)</span><br><span class="line">    : <span class="built_in">require</span>(<span class="string">'./schedule/img/schedule-icon-2-active.png'</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;TabBarIOS tintColor=&#123;F8Colors.darkText&#125;&gt;</span><br><span class="line">      &lt;TabBarItemIOS</span><br><span class="line">        title=<span class="string">"Schedule"</span></span><br><span class="line">        selected=&#123;<span class="keyword">this</span>.props.activeTab === <span class="string">'schedule'</span>&#125;</span><br><span class="line">        onPress=&#123;<span class="keyword">this</span>.onTabSelect.bind(<span class="keyword">this</span>, <span class="string">'schedule'</span>)&#125;</span><br><span class="line">        icon=&#123;scheduleIcon&#125;</span><br><span class="line">        selectedIcon=&#123;scheduleIconSelected&#125;&gt;</span><br><span class="line">        &lt;GeneralScheduleView</span><br><span class="line">          navigator=&#123;<span class="keyword">this</span>.props.navigator&#125;</span><br><span class="line">          onDayChange=&#123;<span class="keyword">this</span>.handleDayChange&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;<span class="regexp">/TabBarItemIOS&gt;</span></span><br><span class="line"><span class="regexp">      &lt;TabBarItemIOS</span></span><br><span class="line"><span class="regexp">        title="My F8"</span></span><br><span class="line"><span class="regexp">        selected=&#123;this.props.activeTab === 'my-schedule'&#125;</span></span><br><span class="line"><span class="regexp">        onPress=&#123;this.onTabSelect.bind(this, 'my-schedule')&#125;</span></span><br><span class="line"><span class="regexp">        icon=&#123;require('./</span>schedule/img/my-schedule-icon.png<span class="string">')&#125;</span></span><br><span class="line"><span class="string">        selectedIcon=&#123;require('</span>./schedule/img/my-schedule-icon-active.png<span class="string">')&#125;&gt;</span></span><br><span class="line"><span class="string">        &lt;MyScheduleView</span></span><br><span class="line"><span class="string">          navigator=&#123;this.props.navigator&#125;</span></span><br><span class="line"><span class="string">          onJumpToSchedule=&#123;() =&gt; this.props.onTabSelect('</span>schedule<span class="string">')&#125;</span></span><br><span class="line"><span class="string">        /&gt;</span></span><br><span class="line"><span class="string">      &lt;/TabBarItemIOS&gt;</span></span><br><span class="line"><span class="string">      &lt;TabBarItemIOS</span></span><br><span class="line"><span class="string">        title="Map"</span></span><br><span class="line"><span class="string">        selected=&#123;this.props.activeTab === '</span>map<span class="string">'&#125;</span></span><br><span class="line"><span class="string">        onPress=&#123;this.onTabSelect.bind(this, '</span>map<span class="string">')&#125;</span></span><br><span class="line"><span class="string">        icon=&#123;require('</span>./maps/img/maps-icon.png<span class="string">')&#125;</span></span><br><span class="line"><span class="string">        selectedIcon=&#123;require('</span>./maps/img/maps-icon-active.png<span class="string">')&#125;&gt;</span></span><br><span class="line"><span class="string">        &lt;F8MapView /&gt;</span></span><br><span class="line"><span class="string">      &lt;/TabBarItemIOS&gt;</span></span><br><span class="line"><span class="string">      &lt;TabBarItemIOS</span></span><br><span class="line"><span class="string">        title="Notifications"</span></span><br><span class="line"><span class="string">        selected=&#123;this.props.activeTab === '</span>notifications<span class="string">'&#125;</span></span><br><span class="line"><span class="string">        onPress=&#123;this.onTabSelect.bind(this, '</span>notifications<span class="string">')&#125;</span></span><br><span class="line"><span class="string">        badge=&#123;this.state.notificationsBadge&#125;</span></span><br><span class="line"><span class="string">        icon=&#123;require('</span>./notifications/img/notifications-icon.png<span class="string">')&#125;</span></span><br><span class="line"><span class="string">        selectedIcon=&#123;require('</span>./notifications/img/notifications-icon-active.png<span class="string">')&#125;&gt;</span></span><br><span class="line"><span class="string">        &lt;F8NotificationsView navigator=&#123;this.props.navigator&#125; /&gt;</span></span><br><span class="line"><span class="string">      &lt;/TabBarItemIOS&gt;</span></span><br><span class="line"><span class="string">      &lt;TabBarItemIOS</span></span><br><span class="line"><span class="string">        title="Info"</span></span><br><span class="line"><span class="string">        selected=&#123;this.props.activeTab === '</span>info<span class="string">'&#125;</span></span><br><span class="line"><span class="string">        onPress=&#123;this.onTabSelect.bind(this, '</span>info<span class="string">')&#125;</span></span><br><span class="line"><span class="string">        icon=&#123;require('</span>./info/img/info-icon.png<span class="string">')&#125;</span></span><br><span class="line"><span class="string">        selectedIcon=&#123;require('</span>./info/img/info-icon-active.png<span class="string">')&#125;&gt;</span></span><br><span class="line"><span class="string">        &lt;F8InfoView navigator=&#123;this.props.navigator&#125; /&gt;</span></span><br><span class="line"><span class="string">      &lt;/TabBarItemIOS&gt;</span></span><br><span class="line"><span class="string">    &lt;/TabBarIOS&gt;</span></span><br><span class="line"><span class="string">  );</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以看见，尽管iOS的菜单使用了许多相同的数据，但它们的结构完全不一样。<a href="http://facebook.github.io/react-native/docs/tabbarios-item.html#content" target="_blank" rel="noopener"><code>TabBarItemIOS</code></a>作为子元素被插入到父亲菜单中，而不是用一个单独的方法来创建菜单项。</p>
<p>这些<code>TarBarItem</code>本质上等同于Android的<code>MenuItem</code>组件 － 不同之处在于Android组件我们定义了一个单一的主<a href="(http://facebook.github.io/react-native/docs/view.html#content"><code>View</code>组件</a>来展示内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;View style=&#123;styles.content&#125; key=&#123;<span class="keyword">this</span>.props.activeTab&#125;&gt;</span><br><span class="line">  &#123;<span class="keyword">this</span>.renderContent()&#125;</span><br><span class="line">&lt;<span class="regexp">/View&gt;</span></span><br></pre></td></tr></table></figure>
<p>并且当一个tab发生改变时会改变这个view组件（通过<code>renderContent()</code>方法），而iOS组件则有许多独立的<code>View</code>组件作为当<code>TarBarItem</code>被点击时需要显示的内容，例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;GeneralScheduleView</span><br><span class="line">  navigator=&#123;<span class="keyword">this</span>.props.navigator&#125;</span><br><span class="line">  onDayChange=&#123;<span class="keyword">this</span>.handleDayChange&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<h3 id="设计迭代"><a href="#设计迭代" class="headerlink" title="设计迭代"></a>设计迭代</h3><p>当你创建任何一种app，移动端的或者web端的，快速的微调和调整UI元素有时候会变的很痛苦。如果一个工程师和一个设计师一起合作，这会把整个进度拖慢。</p>
<p>React Native包含了一个<a href="http://facebook.github.io/react-native/docs/debugging.html#live-reload" target="_blank" rel="noopener">自动重新加载</a>的调试特性，只要Javascript代码改变就会触发app的刷新。这会缩减设计迭代的过程 － 比如改变一个组件的样式，保存，然后你就会立刻看见手机上的变化。</p>
<p>但是如果一个组件在不同的条件下外观也不一样呢？例如，一个按钮组件可能会有一个默认的样式，但是还会有一个按下的样式，一个正在执行任务的样式，一个已经完成任务的样式，等等。</p>
<p>为了避免每次都要和app进行交互，我们创建了一个可视化调试的<code>Playground</code>组件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/setup.js */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Playground</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> content = [];</span><br><span class="line">    <span class="keyword">const</span> define = <span class="function">(<span class="params">name: string, render: <span class="built_in">Function</span></span>) =&gt;</span> &#123;</span><br><span class="line">      content.push(&lt;Example key=&#123;name&#125; render=&#123;render&#125; /&gt;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    var AddToScheduleButton = require('./tabs/schedule/AddToScheduleButton');</span><br><span class="line">    AddToScheduleButton.__cards__(define);</span><br><span class="line">    this.state = &#123;content&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;View style=&#123;&#123;paddingTop: 20&#125;&#125;&gt;</span><br><span class="line">        &#123;this.state.content&#125;</span><br><span class="line">      &lt;/View&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很简单的创建了一个空的view，这个view可以用来在加载的时候不加载真实的app而是置换成别的view。当我们将这个和一个UI组件中的一些示例定义组合在一起，例如 <code>AddToScheduleButton.js</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/tabs/schedule/AddToScheduleButton.js */</span></span><br><span class="line"><span class="built_in">module</span>.exports.__cards__ = <span class="function">(<span class="params">define</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> f;</span><br><span class="line">  setInterval(<span class="function"><span class="params">()</span> =&gt;</span> f &amp;&amp; f(), <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  define(<span class="string">'Inactive'</span>, (state = <span class="literal">true</span>, update) =&gt;</span><br><span class="line">    &lt;AddToScheduleButton isAdded=&#123;state&#125; onPress=&#123;() =&gt; update(!state)&#125; /&gt;);</span><br><span class="line"></span><br><span class="line">  define(<span class="string">'Active'</span>, (state = <span class="literal">false</span>, update) =&gt;</span><br><span class="line">    &lt;AddToScheduleButton isAdded=&#123;state&#125; onPress=&#123;() =&gt; update(!state)&#125; /&gt;);</span><br><span class="line"></span><br><span class="line">  define(<span class="string">'Animated'</span>, (state = <span class="literal">false</span>, update) =&gt; &#123;</span><br><span class="line">    f = <span class="function"><span class="params">()</span> =&gt;</span> update(!state);</span><br><span class="line">    <span class="keyword">return</span> &lt;AddToScheduleButton isAdded=&#123;state&#125; /&gt;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们可以把app变成一个UI预览工具：</p>
<p><img src="https://raw.githubusercontent.com/facebook/makeitopen/gh-pages/static/images/button-playground.gif" alt="UI preview playground in action with a button and three different states"></p>
<p>这个例子定义了按钮包括按下和没有按下的状态，而第三个例子在前两个状态下来回切换以展示状态迁移的动画。</p>
<p>这让我们可以一边和设计师一起合作一边快速的调整基本组件的样式。</p>
<p>如果你想利用这个，<code>&lt;Playground&gt;</code>组件可以在任意React Native app当中重用。为了启用这个组件，我们所需要做的只是在<code>setup()</code>方法中改变一点点代码来加载<code>&lt;Playground&gt;</code>组件而不是真实的app：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/setup.js */</span></span><br><span class="line">render() &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Provider store=&#123;<span class="keyword">this</span>.state.store&#125;&gt;</span><br><span class="line">      &lt;F8App /&gt;</span><br><span class="line">    &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>改为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* in js/setup.js */</span></span><br><span class="line">render() &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Provider store=&#123;<span class="keyword">this</span>.state.store&#125;&gt;</span><br><span class="line">      &lt;Playground /&gt;</span><br><span class="line">    &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>&lt;Playground&gt;</code>组件本身可以修改导入到其中的组件。（你想要在Playground中展示哪个组件，在Playground中引入该组件并修改相应的代码即可)</p>
<h2 id="整合React-Native和数据"><a href="#整合React-Native和数据" class="headerlink" title="整合React Native和数据"></a>整合React Native和数据</h2><p><a href="http://facebook.github.io/react/" target="_blank" rel="noopener">React</a>及其扩展<a href="http://facebook.github.io/react-native/" target="_blank" rel="noopener">React Native</a>, 允许你创建app而不必太担心你的数据从何而来，因此你可以专注在创建app的UI和逻辑部分。</p>
<p>在第一部分， 我们提到我们是如何选用Parse服务端来实际存储数据的，并且我们将在app当中使用Redux来处理数据。在这一部分，我们将解释Redux是如何在React Native app里工作的，以及连接Parse服务端的简单过程。</p>
<p>在我们讨论Redux之前，让我们先从React是如何和数据进行整合进而诞生了Redux开始。</p>
<h3 id="首先，React-app是如何与数据交互的？"><a href="#首先，React-app是如何与数据交互的？" class="headerlink" title="首先，React app是如何与数据交互的？"></a>首先，React app是如何与数据交互的？</h3><p>React通常被提到是作为MVC架构中的’View’层，但它远比’View’层要精妙的多 － React本质上重新审视了MVC总体的模式。</p>
<p>让我们首先回顾一下MVC架构的思路：</p>
<ul>
<li>model就是数据。</li>
<li>view是数据如何在app当中呈现。</li>
<li>controller提供了在app当中处理数据的逻辑。</li>
</ul>
<p>React让你创建了多个组件来组成一个view，但是每个组件也可以处理一个controller可能会提供的逻辑。例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="comment">// 渲染已有数据的视图，</span></span><br><span class="line">        <span class="comment">// 可能是一个潜在的form，通过handleSubmit方法触发数据改变</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handleSubmit(e) &#123;</span><br><span class="line">        <span class="comment">// 修改数据，类似于一个controller的逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一个React app中的每个组件都会知晓两种不同类型的数据，这两种类型的数据具有不同的角色：</p>
<ul>
<li><code>props</code>是当一个组件被创建时传递进来的数据，通常被用作组件的选项。如果你有一个按钮组件，按钮的文本可以作为一个<code>prop</code>。一个组件不可以改变自己的<code>props</code>(也就是说，它们是不可变的)。</li>
<li><code>state</code>是组件可以随时改变的数据。如果上面例子中的按钮是一个登录/登出按钮，那面<code>state</code>可能会存储用户现在的登录状态，按钮能够访问这个state，并且如果点击了按钮可以修改state以改变它们的状态。</li>
</ul>
<p>为了让React app减少重复，<code>state</code>通常被app组件层级中的最高级别的父组件所拥有 － 我们在教程的其它部分指代为<strong>容器组件</strong>。换句话说，在上面的例子中，你不会把state放在按钮组件中，而是把它放在按钮组件的父元素中，然后用<code>props</code>来传递<code>state</code>中相关的部分给子组件。正因为如此，在任何app当中，数据只能单向的向下传递，保证了开发快速及模块化。</p>
<p>如果你想的话，你可以进一步阅读React网站上的<a href="https://facebook.github.io/react/docs/thinking-in-react.html" target="_blank" rel="noopener">Thinkng in React</a>指南来理解这些理论背后的原因和想法。</p>
<h3 id="保存状态"><a href="#保存状态" class="headerlink" title="保存状态"></a>保存状态</h3><p>为了进一步解释React app当中使用数据相关的技术，Facebook提出了<a href="(https://facebook.github.io/flux/docs/overview.html">Flux架构</a>，它是最初用来在app里实现的设计模式，并不是一个可以使用的实际框架。我们不在app当中使用<a href="https://github.com/facebook/flux" target="_blank" rel="noopener">Flux库</a>，但是我们所使用的Redux框架是从Flux架构演化而来，所以让我们先来探究一下Flux。</p>
<p>引入Stores的概念、app的<code>state</code>对象的容器和实时改变<code>state</code>的新工作流程扩大了React的数据关系：</p>
<ul>
<li>Flux app当中的每个<strong>Store</strong>有一个在Dispatcher中注册的回调函数。</li>
<li><strong>Views</strong>(通常来说是React组件)可以触发<strong>Actions</strong> - 通常是一个包含了一大堆代表已发生事情的数据(比如，它可能包括刚刚在app表单当中输入的新数据)以及<strong>action type(动作类型)</strong> - 本质上是一个描述所执行动作的类型的常量。</li>
<li>Action会被发送至<strong>Dispatcher</strong>.</li>
<li>Dispatcher将这个Action传播给所有注册的Store回调函数。</li>
<li>如果Store可以判断它被这个Action所影响（因为动作类型是和数据相关的），Store会更新自己，因此也包括所包含的<code>state</code>。一旦更新完成，它会发送一个change事件。</li>
<li><strong>Controller Views</strong>(我们之前提过的容器组件的一个好听的名字) 是特殊的视图，它会监听这些change事件，当它们捕获到一个change事件时，它们就知道应该去获取新的Store数据。</li>
<li>一旦获取新数据完成，它们会用新数据调用<code>setState()</code>方法，引起View内部组件的重新渲染。</li>
</ul>
<p>你可以看到Flux是怎么帮助保证在React app内部的单向数据流动，并且使得React的数据部分变得更优雅更结构化。</p>
<p>我们并不直接使用Flux，因此我们不会详细介绍这一部分，但是如果你想了解更多，可以去阅读Flux网站上的<a href="https://facebook.github.io/flux/docs/todo-list.html" target="_blank" rel="noopener">教程</a>。</p>
<p>那么我们app当中实际使用的框架Redux是怎么和Flux联系在一起的？</p>
<h3 id="从Flux到Redux"><a href="#从Flux到Redux" class="headerlink" title="从Flux到Redux"></a>从Flux到Redux</h3><p>Redux是Flux架构的一种实现，但它也简化了框架，并且有<a href="https://github.com/reactjs/react-redux" target="_blank" rel="noopener">React-Redux包</a>提供的官方绑定工具来帮助更简单的整合React app和Redux。</p>
<p>Redux中并没有调度器(Dispatcher)，并且整个app当中只有一个<code>state</code>的Store。</p>
<p>Redux中的数据流动是怎样进行的？下面我们会详细讲述，但首先有这些基础概念：</p>
<ul>
<li>React组件会触发Actions，比如通过点击一个按钮。</li>
<li>Actions是通过<code>dispatch</code>方法发送给Store的对象（包含一个<code>type</code>标签和一些其它相关数据）。</li>
<li>Stores将Action的内容同当前的<code>state</code>树(<a href="https://egghead.io/lessons/javascript-redux-the-single-immutable-state-tree" target="_blank" rel="noopener"><code>state</code>树</a>是一个单一的以独特的结构包含所有<code>state</code>数据的对象)一同发送给Reducers。</li>
<li>Reducer是一个<a href="http://redux.js.org/docs/basics/Reducers.html#handling-actions" target="_blank" rel="noopener">单纯的方法</a>，获取之前的<code>state</code>和Action，然后根据Action所指示的改变返回一个新的<code>state</code>。一个Redux app可以有一个Reducer, 但是大多数app会包含若干个Reducer，每一个处理一部分<code>state</code>(我们将会在下面进一步介绍).</li>
<li>Store接收新的<code>state</code>，并且替换掉当前的state.当我们说<code>state</code>被<em>更新</em>时并没有什么值得提的，它就是被<em>替换了</em>。</li>
<li>当<code>state</code>改变时，Store会触发一个<a href="http://redux.js.org/docs/api/Store.html#subscribe" target="_blank" rel="noopener">change事件</a>。</li>
<li>任何<a href="http://redux.js.org/docs/api/Store.html#subscribe" target="_blank" rel="noopener">订阅了change事件</a>的React组件会调用方法<a href="http://redux.js.org/docs/api/Store.html#getState" target="_blank" rel="noopener">从Store里获取最新的<code>state</code></a>.</li>
<li>新的<code>state</code>会更新这些组件。</li>
</ul>
<p>这个流程可以简单的总结为下图：</p>
<p><img src="https://raw.githubusercontent.com/facebook/makeitopen/gh-pages/static/images/redux_flowchart.png" alt="Redux data flow as described above"></p>
<p>你可以看到数据是如何清晰的顺着单向路径流转，没有交叉重叠、反向流动。这也展示了app可以怎样清晰的将各个部分分隔开 － Store仅仅关心怎么持有<code>state</code>; Views中的组件仅仅关心展示数据及触发Action; Actions仅仅关注如何指示<code>state</code>中的一部分发生了改变以及包括相关的数据; Reducers仅仅关心怎么将旧的<code>state</code>和可变的Actions转变成新的<code>state</code>。当阅读并理解代码时会发现每部分都很模块化，优雅，并且有一个清晰的目的。</p>
<p>同Flux相比还有一些其它优点：</p>
<ul>
<li>Actions是唯一触发<code>state</code>改变的方式，这将状态改变的过程集中管理，并与UI组件相剥离，并且由于它们会在Reducer中恰当的排序执行，从而能够防止竞态条件。</li>
<li><code>state</code>实质上是不可变的，从而会创建了一系列的<code>state</code>，其中每个state都代表了一次独立的改变。这会提供给你一个app中清晰容易追溯的<code>state</code>历史记录。</li>
</ul>
<h3 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h3><p>我们已经很抽象的讲述了数据流，那么现在让我们看一看我们的React app是如何将所有这些拼凑到一起使用的。</p>
<h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><p><a href="http://redux.js.org/docs/basics/Store.html" target="_blank" rel="noopener">Redux文档</a>非常详细的解释了如何创建一个简单的Store，因此我们假设你已经阅读过了这些基本内容，略过这部分内容直接跳到我们的Store中的一些特色。</p>
<h5 id="Store的离线同步"><a href="#Store的离线同步" class="headerlink" title="Store的离线同步"></a>Store的离线同步</h5><p>我们之前已经提到过数据离线存储的需求，从而我们的app可以在弱信号或者无信号的条件(这在技术会议当中十分重要！)下操作。所幸由于我们使用Redux，有一个我们可以在app当中使用的非常简单的模块：<a href="https://www.npmjs.com/package/redux-persist" target="_blank" rel="noopener">Redux Persist</a>。</p>
<p>我们还在Store中使用了一个叫做<a href="http://redux.js.org/docs/advanced/Middleware.html" target="_blank" rel="noopener"><strong>Middleware</strong></a>的东西 － 我们将会在测试章节中介绍更多关于中间件的内容，但是简单来说，中间件允许你在Action被分派和它到达Reducer这一过程中间加入额外的逻辑(这对于日志、崩溃记录、异步API等等之类事情很有用)。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* js/store/configureStore.js */</span></span><br><span class="line"><span class="keyword">var</span> createF8Store = applyMiddleware(...)(createStore);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">onComplete: ?(</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> store = autoRehydrate()(createF8Store)(reducers);</span><br><span class="line">  persistStore(store, &#123;<span class="attr">storage</span>: AsyncStorage&#125;, onComplete);</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这的嵌套函数语法可能会有一点令人困惑（有些函数返回了一个需要将另一个函数作为参数的函数）。稍微将代码扩展一下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* js/store/configureStore.js */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> middlewareWrapper = applyMiddleware(...);</span><br><span class="line"><span class="keyword">var</span> createF8Store = middlewareWrapper(createStore(reducers));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">onComplete: ?(</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> rehydrator = autoRehydrate();</span><br><span class="line">  <span class="keyword">const</span> store = rehydrator(createF8Store);</span><br><span class="line">  persistStore(store, &#123;<span class="attr">storage</span>: AsyncStorage&#125;, onComplete);</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在第3行使用Redux的<code>applyMiddleware()</code>方法(如果你想了解更多内容，阅读<a href="http://redux.js.org/docs/api/applyMiddleware.html" target="_blank" rel="noopener">Redux <code>applyMiddleware</code>文档</a>)激活了中间件, 这个方法返回了一个可以增强Store对象的函数。</p>
<p>然后在第4行我们将Redux的<a href="http://redux.js.org/docs/api/createStore.html" target="_blank" rel="noopener"><code>createStore()</code></a>方法(app当中的所有Reducers作为参数)包在这个增强的函数里。<code>createStore()</code>返回app的Store对象，<code>middlewareWrapper()</code>用中间件增强了这个对象，并且将增强后的结果Store对象存储在<code>createF8Store</code>中。</p>
<p>然后我们对Store对象进行了稍许配置。<a href="https://github.com/rt2zz/redux-persist#autorehydrate" target="_blank" rel="noopener">Persist的<code>autoRehydrate()</code></a>是另一个Store增强函数(同<code>applyMiddleware()</code>一样返回一个函数)，我们将已有的Store对象传给它(第8行)。<code>autoRehydrate()</code>将之前保存在本地存储的Store对象取出并且自动用<code>state</code>更新现有的Store。</p>
<p>第9行<a href="https://github.com/rt2zz/redux-persist#persiststorestore-config-callback" target="_blank" rel="noopener">Persist包的<code>persistStore()</code></a>是实际上处理保存app的Store到本地存储的函数(我们已经配置好使用<a href="https://facebook.github.io/react-native/docs/asyncstorage.html" target="_blank" rel="noopener">React Native内建的AsyncStorage系统</a>)。这部分简单的<code>autoRehydrate()</code>和<code>persistStore()</code>代码是我们app中需要的所有启用离线同步的代码。</p>
<p>现在，无论何时app丢失了互联网连接，Store最近的一次拷贝仍然会在本地存储里等待着，从用户层面来看，app仍然正常的运行。</p>
<p>更多信息可以阅读<a href="https://www.npmjs.com/package/redux-persist#basic-usage" target="_blank" rel="noopener">Redux Persist如何工作的技术细节</a>，不过实质上我们已经完成了创建Store的工作。</p>
<h5 id="Reducers"><a href="#Reducers" class="headerlink" title="Reducers"></a>Reducers</h5><p> 在之前解释Redux的过程中，我们提到引入了一个Reducer对象。然而每个app当中可以有多个Reducers，每个关注<code>state</code>的不同部分。举个简单的例子，在一个评论app当中，你可以有一个与登录状态有关的reducer以及其它和实际评论数据有关的reducers。</p>
<p> 在我们的F8 app当中，我们将reducers存储在<code>js/reducers/</code>中。以下是摘抄<code>user.js</code>中的一部分:</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* js/reducers/user.js */</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">import</span> type &#123;Action&#125; <span class="keyword">from</span> <span class="string">'../actions/types'</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  isLoggedIn: <span class="literal">false</span>,</span><br><span class="line">  hasSkippedLogin: <span class="literal">false</span>,</span><br><span class="line">  sharedSchedule: <span class="literal">null</span>,</span><br><span class="line">  id: <span class="literal">null</span>,</span><br><span class="line">  name: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params">state: State = initialState, action: Action</span>): <span class="title">State</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (action.type === <span class="string">'LOGGED_IN'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;id, name, sharedSchedule&#125; = action.data;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      isLoggedIn: <span class="literal">true</span>,</span><br><span class="line">      hasSkippedLogin: <span class="literal">false</span>,</span><br><span class="line">      sharedSchedule,</span><br><span class="line">      id,</span><br><span class="line">      name,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (action.type === <span class="string">'SKIPPED_LOGIN'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      isLoggedIn: <span class="literal">false</span>,</span><br><span class="line">      hasSkippedLogin: <span class="literal">true</span>,</span><br><span class="line">      sharedSchedule: <span class="literal">null</span>,</span><br><span class="line">      id: <span class="literal">null</span>,</span><br><span class="line">      name: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (action.type === <span class="string">'LOGGED_OUT'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> initialState;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (action.type === <span class="string">'SET_SHARING'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...state,</span><br><span class="line">      sharedSchedule: action.enabled,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = user;</span><br></pre></td></tr></table></figure>
<p>可以看出，这个reducer和登录/登出操作以及用户特定的选项改变相关。让我们一一来看。</p>
<p>注意：我们在第16行使用了ES2015的<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment" target="_blank" rel="noopener">解构赋值</a>语法，会将<code>action.data</code>里的每个值赋值给左边的各个变量。</p>
<h5 id="1-初始状态"><a href="#1-初始状态" class="headerlink" title="1.初始状态"></a>1.初始状态</h5><p>一开始我们遵循<a href="http://flowtype.org/docs/type-aliases.html" target="_blank" rel="noopener">Flow的类型声明</a>（我们会在测试React Native app当中详细解释）定义了初始状态（第6行），<code>initialState</code>定义了app第一次加载时需要的值，或者在任何之前同步的Store ‘rehydrated’之前需要的值，这个initialState只定义了<code>state</code>树中这个reducer需要处理的那部分。</p>
<h5 id="2-Reducer-方法"><a href="#2-Reducer-方法" class="headerlink" title="2.Reducer 方法"></a>2.Reducer 方法</h5><p>然后，我们编写了Reducer的主要部分（第14行至第50行），它实际上非常简单。<code>state</code>和一个Action作为参数，<code>initialState</code>作为<code>state</code>的默认值。然后我们根据接收到的Action(有一个’type’标签指定这个Action的类型)，返回一个新的改变过的<code>state</code>。</p>
<p>举个例子，如果分配到了<code>LOGGED_OUT</code> Action（第37行）(因为用户点击了一个登出按钮)，我们将<code>state</code>树的这部分重置为<code>initialState</code>。如果<code>LOGGED_IN</code> Action出现了（第15行），app会用Action中剩余的数据负载，返回一个新的<code>state</code>，<code>state</code>反应既包括标准值的改变比如<code>isLoggedIn</code>，又包括了来自于用户输入数据的变化比如<code>name</code>。</p>
<p>还有一个值得我们注意，就是<code>SET_SHARING</code> Action类型（第40行）。因为它用到了一个很有趣的<code>...state</code>标记。它(也被叫做<a href="http://redux.js.org/docs/recipes/UsingObjectSpreadOperator.html" target="_blank" rel="noopener">对象展开操作符</a>)比<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/assign" target="_blank" rel="noopener"><code>Object.assign()</code></a>更简洁更具可读性，它是包含在<a href="https://facebook.github.io/react-native/docs/javascript-environment.html#javascript-syntax-transformers" target="_blank" rel="noopener">React中的Javascript语法转换器</a>的一部分。它实际上做的是创建了一个对象包括现有<code>state</code>的拷贝同时更新了<code>sharedSchedule</code>的值。</p>
<p>你可以看到这个Reducer结构是有多么的简洁并有可读性 － 定义了一个<code>initialState</code>、创建了一个把<code>state</code>和Action作为参数并返回一个新的<code>state</code>的方法，仅此而已。</p>
<p>我们这个方法里其它事情都没做因为关于reducers有一条很重要的规则，我们一字不差的从<a href="http://redux.js.org/docs/basics/Reducers.html#handling-actions" target="_blank" rel="noopener">Redux文档</a>里引用过来：</p>
<blockquote>
<p>记住reducer必须保持纯粹。给定同样的参数，它应当计算下一个状态并将其返回。没有任何意外，没有任何副作用，没有任何API的调用，没有任何对对象的修改。仅仅是一个计算。</p>
</blockquote>
<p>另外值得注意的一点：看看<code>js/reducers/notifications.js</code>，也引用了<code>LOGGED_OUT</code>类型的Action；我们之前提到过，但是还得再重复一次 － 一个Action被分配以后总会调用每一个reducer，因此多个reducers可能会根据同一个Action更新<code>state</code>树的不同部分。</p>
<h3 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h3><p>让我们仔细看看登录相关的Action，看它在代码中是处于什么样的位置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/actions/login.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">skipLogin</span>(<span class="params"></span>): <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="string">'SKIPPED_LOGIN'</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个非常简单的Action生成器（这个生成器函数返回的对象实际上就是Action），但你也能看见一个Action的基本结构 － 每个Action都可以是一个很简单的包括自定义<code>type</code>标签的对象。reducers可以用这个<code>type</code>来执行<code>state</code>的更新。</p>
<p>我们也可以在<code>type</code>之外加上一些数据负载：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/actions/filter.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyTopicsFilter</span>(<span class="params">topics</span>): <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="string">'APPLY_TOPICS_FILTER'</span>,</span><br><span class="line">    topics: topics,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的Action生成器接受一个参数，并把它插入到Action对象中。</p>
<p>我们也有一些Action生成器在返回Action对象的同时执行一些额外的逻辑。在这个例子里，我们也使用一个自定义的Action，叫做ThunkAction(<a href="http://redux.js.org/docs/recipes/ReducingBoilerplate.html" target="_blank" rel="noopener">Redux推荐创建类似这种的函数来减少样板代码</a>) － 这种特殊类型的Action生成器返回的不是Action而是一个函数。这种情况下，<code>logOut</code>Action生成器返回一个执行注销相关逻辑再分配Action的函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/actions/login.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logOut</span>(<span class="params"></span>): <span class="title">ThunkAction</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    Parse.User.logOut();</span><br><span class="line">    FacebookSDK.logout();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dispatch(&#123;</span><br><span class="line">      type: <span class="string">'LOGGED_OUT'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(注意我们在这个例子中使用了<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="noopener">箭头函数语法</a>)</p>
<h5 id="异步Actions"><a href="#异步Actions" class="headerlink" title="异步Actions"></a>异步Actions</h5><p>假如你需要和API交互，那你会需要一些异步的Actions生成器。Redux本身有一个<a href="http://redux.js.org/docs/advanced/AsyncActions.html" target="_blank" rel="noopener">相当复杂的方式来实现异步</a>，但由于我们在使用React Native，我们可以使用<a href="https://facebook.github.io/react-native/docs/javascript-environment.html#javascript-syntax-transformers" target="_blank" rel="noopener">ES7的await功能</a>来简化这一过程：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/actions/config.js */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">loadConfig</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Action</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = <span class="keyword">await</span> Parse.Config.get();</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="string">'LOADED_CONFIG'</span>,</span><br><span class="line">    config,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们访问了Parse的API来获取一些app的配置数据。任何一个类似的访问网络资源的API都会花费一定的时间。Action生成器首先等待API调用的结果(不会阻塞Javascript线程)，然后一旦数据获取到了就会返回Action对象(将API数据放在负载里)，而不是将Action立刻分配。</p>
<p>像这样异步调用的一个好处是当我们异步等待<code>Parse.Config</code>调用的结果时，其它的一些异步操作也可以同时进行，因此我们可以将许多操作组合在一起，自动提高操作的效率。</p>
<h3 id="绑定组件"><a href="#绑定组件" class="headerlink" title="绑定组件"></a>绑定组件</h3><p>现在我们在app的setup函数中将Redux的逻辑和React联系在一起：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/setup.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params"></span>): <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ... other setup logic</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Root</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">      <span class="keyword">super</span>();</span><br><span class="line">      <span class="keyword">this</span>.state = &#123;</span><br><span class="line">        store: configureStore(),</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    render() &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        &lt;Provider store=&#123;<span class="keyword">this</span>.state.store&#125;&gt;</span><br><span class="line">          &lt;F8App /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">      );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return Root;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>我们用的是官方的<a href="https://github.com/reactjs/react-redux" target="_blank" rel="noopener">React-Redux绑定库</a>，因此我们可以使用内置的<a href="http://redux.js.org/docs/basics/UsageWithReact.html#passing-the-store" target="_blank" rel="noopener"><code>&lt;Provider&gt;</code>组件</a>(如第14行所示)。Provider允许我们将已创建好的Store连接到任意我们想要连接的组件上：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/F8App.js */</span></span><br><span class="line"><span class="keyword">var</span> F8App = React.createClass(&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    notifications: state.notifications,</span><br><span class="line">    isLoggedIn: state.user.isLoggedIn || state.user.hasSkippedLogin,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = connect(select)(F8App);</span><br></pre></td></tr></table></figure>
<p>上面我们展示了<code>&lt;F8App&gt;</code>组件中的一部分代码 － 整个app的父组件。</p>
<p>第6行的函数是用来获取Redux Store，然后从中获取一些数据，再把它插入到我们<code>&lt;F8App&gt;</code>组件的<code>props</code>中。这种情况下，我们想要将通知相关的数据和用户的登录状态作为组件的<code>props</code>，并且将它们与Store里的任何变化同步。</p>
<p>我们可以使用React-Redux的<a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#connectmapstatetoprops-mapdispatchtoprops-mergeprops-options" target="_blank" rel="noopener"><code>connect()</code>函数</a>来完成这些 － <code>connect()</code>有一个叫做<a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#arguments" target="_blank" rel="noopener"><code>mapStateToProps</code></a>的参数，这个参数会带有另一个函数作为参数并且只要Store一有更新，那个函数就会被调用。</p>
<p>于是当我们app的Store更新时，<code>select()</code>(第6行)会被调用，新<code>state</code>会作为被调用的参数。<code>select()</code>返回一个包含我们想要从新<code>state</code>中获得的数据(这个例子中是<code>notifications</code>和<code>isLoggedIn</code>)，然后第13行调用的<code>connect()</code>会将这个数据融合进<code>&lt;F8App&gt;</code>组件的<code>props</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/F8App.js */</span></span><br><span class="line"><span class="keyword">var</span> F8App = React.createClass(&#123;</span><br><span class="line">  ...</span><br><span class="line">  componentDidMount: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.notifications.enabled &amp;&amp; !<span class="keyword">this</span>.props.notifications.registered) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>我们现在有一个会根据新<code>state</code>数据而更新的<code>&lt;F8App&gt;</code>组件，它通过<code>select()</code>函数订阅了这些新<code>state</code>数据，同时它也能够通过自己的props来访问这些数据(如第6行所示)。但是我们怎么分配组件中的产生的Action呢？</p>
<h5 id="分配组件中产生的Action"><a href="#分配组件中产生的Action" class="headerlink" title="分配组件中产生的Action"></a>分配组件中产生的Action</h5><p>我们来看看<code>&lt;GeneralScheduleView&gt;</code>的相关部分来了解我们是怎么将Action和组件联系在一起的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/tabs/schedule/GeneralScheduleView.js */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GeneralScheduleView</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  props: Props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.renderStickyHeader = <span class="keyword">this</span>.renderStickyHeader.bind(<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">this</span>.switchDay = <span class="keyword">this</span>.switchDay.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;ListContainer</span><br><span class="line">        title=<span class="string">"Schedule"</span></span><br><span class="line">        backgroundImage=&#123;<span class="built_in">require</span>(<span class="string">'./img/schedule-background.png'</span>)&#125;</span><br><span class="line">        backgroundShift=&#123;<span class="keyword">this</span>.props.day - <span class="number">1</span>&#125;</span><br><span class="line">        backgroundColor=&#123;<span class="string">'#5597B8'</span>&#125;</span><br><span class="line">        data=&#123;<span class="keyword">this</span>.props.data&#125;</span><br><span class="line">        renderStickyHeader=&#123;<span class="keyword">this</span>.renderStickyHeader&#125;</span><br><span class="line">        ...</span><br><span class="line">      /&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  renderStickyHeader() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View&gt;</span><br><span class="line">        &lt;F8SegmentedControl</span><br><span class="line">          values=&#123;[<span class="string">'Day 1'</span>, <span class="string">'Day 2'</span>]&#125;</span><br><span class="line">          selectedIndex=&#123;<span class="keyword">this</span>.props.day - <span class="number">1</span>&#125;</span><br><span class="line">          selectionColor=<span class="string">"#51CDDA"</span></span><br><span class="line">          onChange=&#123;<span class="keyword">this</span>.switchDay&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">        ...</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  ...</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  switchDay(page) &#123;</span></span><br><span class="line"><span class="regexp">    this.props.switchDay(page + 1);</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">module.exports = GeneralScheduleView;</span></span><br></pre></td></tr></table></figure>
<p>同样，这部分代码为了展示已经简化了很大一部分内容，不过我们可以添加并且修改第49行的代码来将这个<a href="">容器组件</a>和Redux store联系在一起：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/tabs/schedule/GeneralScheduleView.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    day: store.navigation.day,</span><br><span class="line">    data: data(store),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">actions</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    switchDay: <span class="function">(<span class="params">day</span>) =&gt;</span> dispatch(switchDay(day)),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = connect(select, actions)(GeneralScheduleView);</span><br></pre></td></tr></table></figure>
<p>这次有一点不同 － 我们提供了React-Redux的<a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#connectmapstatetoprops-mapdispatchtoprops-mergeprops-options" target="_blank" rel="noopener"><code>connect()</code>函数</a>的一个可选参数，<a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#arguments" target="_blank" rel="noopener"><code>mapDispatchToProps</code></a>。简单来说，这样会将<code>actions()</code>中的action生成器融合进组件的props中，同时将它们包在<code>dispatch()</code>里好让它们立刻就分配一个Action。</p>
<h5 id="它是如何工作的"><a href="#它是如何工作的" class="headerlink" title="它是如何工作的"></a>它是如何工作的</h5><p>让我们看看实际上的组件长什么样子：</p>
<p><img src="https://raw.githubusercontent.com/facebook/makeitopen/gh-pages/static/images/iOS vs Android Segmented Controls@3x.png" alt="Screenshot of segmented controls"></p>
<p>点击’Day 1’会触发一个<code>renderStickyHeader()</code>中的<code>onChange</code>事件，然后这个组件里的<code>switchDay()</code>函数会被调用，这个函数本身会分配<code>this.props.switchDay()</code>这个action生成器。在我们的一个Actions文件中，我们可以看见这个action生成器：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/actions/navigation.js */</span></span><br><span class="line">  switchDay: (day): <span class="function"><span class="params">Action</span> =&gt;</span> (&#123;</span><br><span class="line">    type: <span class="string">'SWITCH_DAY'</span>,</span><br><span class="line">    day,</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>在导航Reducer里可以发现这会用修改过的<code>day</code>值生成一个新的<code>state</code>树：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/reducers/navigation.js */</span></span><br><span class="line">  <span class="keyword">if</span> (action.type === <span class="string">'SWITCH_DAY'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;...state, <span class="attr">day</span>: action.day&#125;;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这个Reducer(以及其它任何正观测<code>SWITCH_DAY</code>Action的Reducer)返回一个新的<code>state</code>给Store，Store会据此更新自身并发送一个change事件。</p>
<p>并且由于将Redux Store和<code>&lt;GeneralScheduleView&gt;</code>连接在一起，这个组件也订阅了Store中<code>state</code>的改变，组件会用新的改变过的<code>day</code>值刷新，展示第一天的日程安排。</p>
<h3 id="Parse服务端会发生什么呢"><a href="#Parse服务端会发生什么呢" class="headerlink" title="Parse服务端会发生什么呢"></a>Parse服务端会发生什么呢</h3><p>到目前为止你应该已经消化了许多的新知识，不过还是让我们快速的过一下我们是怎么将React Native app和Parse服务器的数据后端连接在一起的，以及它相关的API：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Parse.initialize(</span><br><span class="line">  <span class="string">'PARSE_APP_ID'</span>,</span><br><span class="line">);</span><br><span class="line">Parse.serverURL = <span class="string">'http://exampleparseserver.com:1337/parse'</span></span><br></pre></td></tr></table></figure>
<p>仅此而已，我们在React Native内部就和Parse API连接上了。</p>
<p>当然，由于我们使用了<a href="https://github.com/ParsePlatform/ParseReact" target="_blank" rel="noopener">Parse+React</a>的SDK(其中的<code>parse/react-native</code>包)，我们相当简单就能访问到SDK了。</p>
<h5 id="Parse和Action"><a href="#Parse和Action" class="headerlink" title="Parse和Action"></a>Parse和Action</h5><p>当然，我们想要能够做一些查询(比如在Action里面)…许多的查询。这些action生成器并没有什么特殊的；它们同我们之前提到的异步Actions一样。然而，由于需要如此多的简单Parse API请求来初始化app，我们想要稍微减少一点样板代码。在我们的基础Action文件中，我们创建了一个基础action生成器：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/actions/parse.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadParseQuery</span>(<span class="params">type: string, query: Parse.Query</span>): <span class="title">ThunkAction</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> query.find(&#123;</span><br><span class="line">      success: <span class="function">(<span class="params">list</span>) =&gt;</span> dispatch((&#123;type, list&#125;: any)),</span><br><span class="line">      error: logError,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们可以很简单的重用很多次：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">loadMaps: (): <span class="function"><span class="params">ThunkAction</span> =&gt;</span></span><br><span class="line">  loadParseQuery(<span class="string">'LOADED_MAPS'</span>, <span class="keyword">new</span> Parse.Query(Maps)),</span><br></pre></td></tr></table></figure>
<p><code>loadMaps()</code>是一个action生成器，它会运行简单Parse请求所有存储的地图数据，然后当请求完成时在Action的负载里传递它。<code>loadMaps()</code>和一些其它的Parse数据Action在整个app(<code>js/F8App.js</code>)的<code>componentDidMount()</code>函数中被分配，这意味着app会在初次加载时获取所有的Parse数据。</p>
<h5 id="Parse和Reducer"><a href="#Parse和Reducer" class="headerlink" title="Parse和Reducer"></a>Parse和Reducer</h5><p>我们在Action中已经减少了重复代码，但是我们也想在Reducer中减少样板代码。这些Reducer会接收来自于Action负载的一系列Parse接口数据，并把它们映射到<code>state</code>树中。我们因此为Parse数据创建了一个单一的基础Reducer：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/reducers/createParseReducer.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createParseReducer</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  type: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  convert: Convert&lt;T&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Reducer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">state: ?Array&lt;T&gt;, action: Action</span>): <span class="title">Array</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (action.type === type) &#123;</span><br><span class="line">      <span class="comment">// Flow can't guarantee &#123;type, list&#125; is a valid action</span></span><br><span class="line">      <span class="keyword">return</span> (action: any).list.map(convert);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state || [];</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个很简单的Reducer(包含了许多的Flow类型标注)，不过让我们来看看它是如何和基于它的子Reducer一起工作的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/reducers/faqs.js */</span></span><br><span class="line"><span class="keyword">const</span> createParseReducer = <span class="built_in">require</span>(<span class="string">'./createParseReducer'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type FAQ = &#123;</span><br><span class="line">  id: string;</span><br><span class="line">  question: string;</span><br><span class="line">  answer: string;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromParseObject</span>(<span class="params">map: Object</span>): <span class="title">FAQ</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    id: map.id,</span><br><span class="line">    question: map.get(<span class="string">'question'</span>),</span><br><span class="line">    answer: map.get(<span class="string">'answer'</span>),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = createParseReducer(<span class="string">'LOADED_FAQS'</span>, fromParseObject);</span><br></pre></td></tr></table></figure>
<p>可以看见避免了每次都重复<code>createParseReducer</code>的部分代码，我们仅仅是简单的传递了一个对象给基础Reducer，这个对象将API数据映射为我们想要的<code>state</code>树。</p>
<p>现在我们有了一个结构良好并且通俗易懂的数据流，连接到我们的Parse服务端，甚至可以离线同步我们的Store到本地存储中。</p>
<h2 id="测试React-Native的app"><a href="#测试React-Native的app" class="headerlink" title="测试React Native的app"></a>测试React Native的app</h2><p>在传统的软件开发生命周期中，测试阶段总是被看作是开发快结束时的独立阶段。这在使用了大量开源框架时看起来尤为正确，因为这些框架发布的版本可能并不适用于任何一种测试技术。</p>
<p>所幸Facebook从创建React Native之初就秉承着持续测试技术的理念。在这部分我们会探究你可以如何使用<a href="http://nuclide.io" target="_blank" rel="noopener">Nuclide</a>，<a href="http://flowtype.org" target="_blank" rel="noopener">Flow</a>和<a href="http://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>来提高你所写代码的质量。</p>
<h3 id="Flow-防止写坏代码的类型检查"><a href="#Flow-防止写坏代码的类型检查" class="headerlink" title="Flow: 防止写坏代码的类型检查"></a>Flow: 防止写坏代码的类型检查</h3><p><a href="http://flowtype.org" target="_blank" rel="noopener">Flow</a>给Javascript提供了<a href="http://flowtype.org/docs/about-flow.html#_" target="_blank" rel="noopener">静态类型检查</a>，并且以渐进的方式工作，从而允许你可以逐渐的给你的代码增加Flow的特性。这很有用，因为我们可以给特定的部分代码引入类型检查，而不必把整个app都重写以兼容Flow。</p>
<p>在我们的F8 app当中，我们一开始就决定完整的使用Flow，在任何必要的地方都加上<a href="http://flowtype.org/docs/type-annotations.html#_" target="_blank" rel="noopener">类型标注</a>，让Flow跟随我们的进度同步工作。</p>
<p>例如，让我们看看在数据教程中我们描述的一个简单Action：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/actions/login.js */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @flow</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">skipLogin</span>(<span class="params"></span>): <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="string">'SKIPPED_LOGIN'</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在文件头部加上了<code>@flow</code>标记(这会告诉Flow去检查代码)，然后我们用Flow的<a href="http://flowtype.org/docs/type-annotations.html#_" target="_blank" rel="noopener">类型标注</a>来指示<code>skipLogin()</code>返回的一定是<code>Action</code>类型。但是这个<code>Action</code>类型并不是React Native或者Redux内置的，所以我们需要自己定义一下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/actions/types.js */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> type Action =</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">'LOADED_ABOUT'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_NOTIFICATIONS'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_MAPS'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_FRIENDS_SCHEDULES'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;&#123; <span class="attr">id</span>: string; name: string; schedule: &#123;[key: string]: boolean&#125;; &#125;&gt; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_CONFIG'</span>, <span class="attr">config</span>: ParseObject &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_SESSIONS'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOADED_SURVEYS'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;<span class="built_in">Object</span>&gt; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SUBMITTED_SURVEY_ANSWERS'</span>, <span class="attr">id</span>: string; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOGGED_IN'</span>, <span class="attr">data</span>: &#123; <span class="attr">id</span>: string; name: string; sharedSchedule: ?boolean; &#125; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'RESTORED_SCHEDULE'</span>, <span class="attr">list</span>: <span class="built_in">Array</span>&lt;ParseObject&gt; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SKIPPED_LOGIN'</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'LOGGED_OUT'</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SESSION_ADDED'</span>, <span class="attr">id</span>: string &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SESSION_REMOVED'</span>, <span class="attr">id</span>: string &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SET_SHARING'</span>, <span class="attr">enabled</span>: boolean &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'APPLY_TOPICS_FILTER'</span>, <span class="attr">topics</span>: &#123;[key: string]: boolean&#125; &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'CLEAR_FILTER'</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SWITCH_DAY'</span>, <span class="attr">day</span>: <span class="number">1</span> | <span class="number">2</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SWITCH_TAB'</span>, <span class="attr">tab</span>: <span class="string">'schedule'</span> | <span class="string">'my-schedule'</span> | <span class="string">'map'</span> | <span class="string">'notifications'</span> | <span class="string">'info'</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'TURNED_ON_PUSH_NOTIFICATIONS'</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'REGISTERED_PUSH_NOTIFICATIONS'</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SKIPPED_PUSH_NOTIFICATIONS'</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'RECEIVED_PUSH_NOTIFICATION'</span>, <span class="attr">notification</span>: <span class="built_in">Object</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'SEEN_ALL_NOTIFICATIONS'</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">'RESET_NUXES'</span> &#125;</span><br><span class="line">  ;</span><br></pre></td></tr></table></figure>
<p>这里我们创建了一个Flow的<a href="http://flowtype.org/docs/type-aliases.html#_" target="_blank" rel="noopener">类型声明</a>，Action类型的任何对象都必须是以下不同类型之一。<code>SKIPPED_LOGIN</code>Action必须只包含它自己的类型标签，相较而言，<code>LOADED_SURVEYS</code> Action必须返回类型标签以及一个列表。我们可以看见相关的Action生成器所做的就是这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/actions/surveys.js */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">loadSurveys</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Action</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> list = <span class="keyword">await</span> Parse.Cloud.run(<span class="string">'surveys'</span>);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="string">'LOADED_SURVEYS'</span>,</span><br><span class="line">    list,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于我们在app当中使用了大量不同的Action，这种强类型检查让我们知道一些简单的错误比如type标签中的拼写错误，或者是其它一些重要的错误比如数据负载的数据格式错误。</p>
<p>我们在Reducer中也可以使用同样的强类型检查：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/reducers/surveys.js */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">surveys</span>(<span class="params">state: State = [], action: Action</span>): <span class="title">State</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (action.type === <span class="string">'LOADED_SURVEYS'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> action.list;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为参数<code>action</code>是上面提到的<code>Action</code>类型，Reducer函数必须使用合法的<code>action.type</code>。我们也可以使用类型声明来给Reducer的<code>state</code>树定义类型：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/reducers/user.js */</span></span><br><span class="line"><span class="keyword">export</span> type State = &#123;</span><br><span class="line">  isLoggedIn: boolean;</span><br><span class="line">  hasSkippedLogin: boolean;</span><br><span class="line">  sharedSchedule: ?boolean;</span><br><span class="line">  id: ?string;</span><br><span class="line">  name: ?string;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  isLoggedIn: <span class="literal">false</span>,</span><br><span class="line">  hasSkippedLogin: <span class="literal">false</span>,</span><br><span class="line">  sharedSchedule: <span class="literal">null</span>,</span><br><span class="line">  id: <span class="literal">null</span>,</span><br><span class="line">  name: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">user</span>(<span class="params">state: State = initialState, action: Action</span>): <span class="title">State</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在数据教程部分展示了这个<code>initialState</code>对象，你现在可以看看我们是怎么强制<code>state</code>树的这部分必须遵循定义好的Flow类型。如果Reducer接收或者尝试返回任何不符合这个格式的<code>state</code>，我们会遇到一个Flow类型检查的错误。</p>
<p>记住Flow检查只在编译时进行，React Native的打包器会<a href="https://github.com/facebook/react-native/blob/master/babel-preset/configs/main.js#L32" target="_blank" rel="noopener">自动把这些Flow标记去除</a> － 这意味着在代码中使用Flow不会带来任何的性能损失。</p>
<p>当然现在我们每次想测试一些代码时还必须手动运行Flow的类型检查(用<a href="http://flowtype.org/docs/cli.html#_" target="_blank" rel="noopener">Flow命令行工具</a>)，不过我们也可以使用Nuclide来在我们<em>写代码</em>时就能进行这类验证。</p>
<h3 id="Nuclide-React-Native开发环境"><a href="#Nuclide-React-Native开发环境" class="headerlink" title="Nuclide: React Native开发环境"></a>Nuclide: React Native开发环境</h3><p>Nuclide网站包含了一系列为React Native量身定制的特色功能，不过只需要说这是React Native的最佳IDE，同样由Facebook创建React Native的那伙人开发，并且他们每天都使用它来编写Facebook的app。</p>
<p>集成Flow是我们很感兴趣的一点。下面是我们之前展示的用<code>state</code>类型的Reducer代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (action.type === <span class="string">'SKIPPED_LOGIN'</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    isLoggedIn: <span class="literal">false</span>,</span><br><span class="line">    hasSkippedLogin: <span class="literal">true</span>,</span><br><span class="line">    sharedSchedule: <span class="literal">null</span>,</span><br><span class="line">    id: <span class="literal">null</span>,</span><br><span class="line">    name: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正如我们之前所说，我们定义了Reducer函数必须返回的格式，在Nuclide中，我们可以实时看见我们发生的错误：</p>
<video width="1174" height="1002" autoplay loop><br>  <source src="static/videos/flow.mp4" type="video/mp4"><br>  Your browser does not support the HTML5 video tag.<br></video>

<p>如果我们留下State类型的任意一部分，快速开发app时很有可能会经常发生一些意外，我们没有返回正确类型的对象时就会得到及时的反馈。</p>
<p>Nuclide会为我们做所有的相关的Flow类型检查。在代码编写的过程当中，就可以注意到类型错误并改正这些错误，而不用等到app即将开发完毕。</p>
<p>这看起来可能很不直观，但它确实加速了开发 － 解开无类型的代码谜团很困难，而且在你都已经开发完app时做这些检查会变得混乱无比。</p>
<h3 id="Jest-无错误修改的单元测试"><a href="#Jest-无错误修改的单元测试" class="headerlink" title="Jest: 无错误修改的单元测试"></a>Jest: 无错误修改的单元测试</h3><p><a href="http://facebook.github.io/jest/" target="_blank" rel="noopener">Jest</a>提供了Javascript的单元测试框架，并且能很好的在React Native app中工作。</p>
<p>我们用这些单元测试来保证已经写好的代码没有因为修改而引入bug(也叫做回归测试)。</p>
<p>比如，我们想要用Jest测试来保证Reducer处理maps的数据能按预期工作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">jest.autoMockOff();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Parse = <span class="built_in">require</span>(<span class="string">'parse'</span>);</span><br><span class="line"><span class="keyword">const</span> maps = <span class="built_in">require</span>(<span class="string">'../maps'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'maps reducer'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'is empty by default'</span>, () =&gt; &#123;</span><br><span class="line">    expect(maps(<span class="literal">undefined</span>, &#123;&#125;)).toEqual([]);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'populates maps from server'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> list = [</span><br><span class="line">      <span class="keyword">new</span> Parse.Object(&#123;<span class="attr">mapTitle</span>: <span class="string">'Day 1'</span>, <span class="attr">mapImage</span>: <span class="keyword">new</span> Parse.File(<span class="string">'1.png'</span>)&#125;),</span><br><span class="line">      <span class="keyword">new</span> Parse.Object(&#123;<span class="attr">mapTitle</span>: <span class="string">'Day 2'</span>, <span class="attr">mapImage</span>: <span class="keyword">new</span> Parse.File(<span class="string">'2.png'</span>)&#125;),</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    expect(</span><br><span class="line">      maps([], &#123;<span class="attr">type</span>: <span class="string">'LOADED_MAPS'</span>, list&#125;)</span><br><span class="line">    ).toEqual([&#123;</span><br><span class="line">      id: jasmine.any(<span class="built_in">String</span>),</span><br><span class="line">      title: <span class="string">'Day 1'</span>,</span><br><span class="line">      url: <span class="string">'1.png'</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      id: jasmine.any(<span class="built_in">String</span>),</span><br><span class="line">      title: <span class="string">'Day 2'</span>,</span><br><span class="line">      url: <span class="string">'2.png'</span>,</span><br><span class="line">    &#125;]);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Jest很容易读懂(注意甚至我们的Jest测试都是用Flow标注类型的！)，但是我们会拆开一步一步看。第4行，我们引入了maps的Reducer函数(<code>js/reducers/maps.js</code>)以便它能够在单元测试中直接使用(Reducer函数是<a href="https://en.wikipedia.org/wiki/Pure_function" target="_blank" rel="noopener">纯粹的函数</a>意味着这很容易做到)。</p>
<p>第8行的第一个测试保证Reducer函数返回一个空数组，如果你看看<code>js/reducers/maps.js</code>中的Reducer代码，你会发现它没有任何初始state，这也是为什么我们想要从这个单元测试中返回一个空数组。</p>
<p>第12行的第二个测试保证当map数据从Parse接口获得时能被Reducer函数正确的转换到<code>state</code>树中的正确结构。这个测试中我们使用了模拟数据对象，完全模仿了真实的存储在Parse的数据结构 － 这可以避免任何API连接上的问题而导致测试失败。</p>
<p>现在我们需要将运行Jest测试作为我们开发工作流中的一部分 － 比如，在提交git之前 － 而且我们可以更自信我们对现有代码的更改不会导致app不能正常运行。</p>
<p>Redux Reducer维护<code>state</code>树的事实是很重要的，保证了不会引入bug，尤其是维护<code>state</code>而带来的bug很容易就被忽略，因为它们可能不会造成功能不正常，而只是发送错误的数据到Parse服务器上。它们纯粹函数的特性使它们是回归测试的完美候选，因为我们可以更准确的预测它们每次应当怎样执行。</p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>当你试图定位一个bug时，或者尝试解决bug时，如果有一些好用的调试工具会很有帮助。我们已经描述过我们怎样构建一个可以调试我们app的可视化组件的系统，但是数据方面怎么调试呢？</p>
<p>我们通过<a href="http://nuclide.io/docs/features/debugger/" target="_blank" rel="noopener">Nuclide</a>使用<a href="https://facebook.github.io/react-native/docs/debugging.html#chrome-developer-tools" target="_blank" rel="noopener">Chrome开发者工具</a>以及<a href="http://fcomb.github.io/redux-logger/" target="_blank" rel="noopener">Redux的日志工具</a>中间件，这个开发者工具提供了带有额外Redux上下文信息的控制台，比如Actions或者Reducers中的<code>state</code>变化：</p>
<p><img src="https://raw.githubusercontent.com/facebook/makeitopen/gh-pages/static/images/redux_logger.png" alt="Redux Logger Middleware in action with additional console context"></p>
<p>你可以看看我们是怎样通过<code>configureStore</code>函数来启用这个日志的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* from js/store/configureStore.js */</span></span><br><span class="line"><span class="keyword">var</span> createLogger = <span class="built_in">require</span>(<span class="string">'redux-logger'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">var</span> isDebuggingInChrome = __DEV__ &amp;&amp; !!<span class="built_in">window</span>.navigator.userAgent;</span><br><span class="line"><span class="keyword">var</span> logger = createLogger(&#123;</span><br><span class="line">  predicate: <span class="function">(<span class="params">getState, action</span>) =&gt;</span> isDebuggingInChrome,</span><br><span class="line">  collapsed: <span class="literal">true</span>,</span><br><span class="line">  duration: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> createF8Store = applyMiddleware(thunk, promise, array, logger)(createStore);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">onComplete: ?(</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> store = autoRehydrate()(createF8Store)(reducers);</span><br><span class="line">  persistStore(store, &#123;<span class="attr">storage</span>: AsyncStorage&#125;, onComplete);</span><br><span class="line">  <span class="keyword">if</span> (isDebuggingInChrome) &#123;</span><br><span class="line">    <span class="built_in">window</span>.store = store;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第5行我们<a href="https://github.com/fcomb/redux-logger#options-1" target="_blank" rel="noopener">用一些选项</a>创建了Logger中间件，然后在第10行我们用Redux的<a href="http://redux.js.org/docs/api/applyMiddleware.html" target="_blank" rel="noopener"><code>applyMiddleware()</code>函数</a>来应用这个中间件。我们做这些就可以在控制台里看那些日志条目。</p>
<p>第4行我们触发了一些额外的调试功能通过使用一个全局变量<code>__DEV__</code>，这让我们通过一个简单的布尔值改变可以自由切换调试模式。它不仅仅决定创建的日志中间件是否记录action(通过<a href="https://github.com/fcomb/redux-logger#predicate--getstate-function-action-object--boolean" target="_blank" rel="noopener"><code>predicate</code>选项</a>)，也在第17行复制了一份现在的Store对象到<a href="http://www.w3schools.com/jsref/obj_window.asp" target="_blank" rel="noopener">Window对象</a>上。避免了每次都要将它附加到Window上，这也使得能够更容易的直接通过浏览器的控制台来访问它。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/06/17/when-swift-generic-inheritance-meets-nsobject/" class="prev">PREV</a><a href="/2015/10/27/mvvm-in-ios-using-reactivecocoa/" class="next">NEXT</a></div><div data-thread-key="2016/04/22/building-the-f8-2016-app/" data-title="构建2016 F8 app" data-url="http://yiyangest.github.io/2016/04/22/building-the-f8-2016-app/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"yiyangest"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2018 <a href="http://yiyangest.github.io">yiyangest</a>, unless otherwise noted.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>